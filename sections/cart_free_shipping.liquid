{% assign spendmsg = '' %}

{% comment %} Currency conversion rates for THRESHOLD {% endcomment %}
{% assign threshold_sgd_rate = 0.858876 %}
{% assign threshold_nzd_rate = 1.09421 %}
{% assign threshold_hkd_rate = 5.1949824 %}

{% comment %} Currency conversion rates for SHIPPING COST {% endcomment %}
{% assign shipping_sgd_rate = 0.840336 %}
{% assign shipping_nzd_rate = 1.672269 %}
{% assign shipping_hkd_rate = 8.394958 %}

{% comment %} Convert shipping cost from string to cents (handles both "11.90" and "1190") {% endcomment %}
{% assign shipping_cost_setting = settings.shipping_cost | times: 1 %}
{% if shipping_cost_setting < 100 %}
  {% comment %} If less than 100, assume it's in dollars (e.g., 11.90) {% endcomment %}
  {% assign base_shipping_cents = shipping_cost_setting | times: 100 | round %}
{% else %}
  {% comment %} If 100 or more, assume it's already in cents (e.g., 1190) {% endcomment %}
  {% assign base_shipping_cents = shipping_cost_setting | round %}
{% endif %}

{% comment %} Convert shipping threshold and cost based on currency {% endcomment %}
{% if cart.currency.iso_code == 'USD' %}
  {% assign shipping_treshold = settings.us_shipping_treshold %}
  {% assign shipping_cost = settings.us_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'CAD' %}
  {% assign shipping_treshold = settings.ca_shipping_treshold %}
  {% assign shipping_cost = settings.ca_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'EUR' %}
  {% assign shipping_treshold = settings.eu_shipping_treshold %}
  {% assign shipping_cost = settings.eu_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'GBP' %}
  {% assign shipping_treshold = settings.gb_shipping_treshold %}
  {% assign shipping_cost = settings.gb_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'BHD' %}
  {% assign shipping_treshold = settings.bh_shipping_treshold %}
  {% assign shipping_cost = settings.bh_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'DKK' %}
  {% assign shipping_treshold = settings.dk_shipping_treshold %}
  {% assign shipping_cost = settings.dk_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'INR' %}
  {% assign shipping_treshold = settings.in_shipping_treshold %}
  {% assign shipping_cost = settings.in_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'JPY' %}
  {% assign shipping_treshold = settings.jp_shipping_treshold %}
  {% assign shipping_cost = settings.jp_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'KWD' %}
  {% assign shipping_treshold = settings.kw_shipping_treshold %}
  {% assign shipping_cost = settings.kw_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'MYR' %}
  {% assign shipping_treshold = settings.my_shipping_treshold %}
  {% assign shipping_cost = settings.my_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'OMR' %}
  {% assign shipping_treshold = settings.om_shipping_treshold %}
  {% assign shipping_cost = settings.om_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'PHP' %}
  {% assign shipping_treshold = settings.ph_shipping_treshold %}
  {% assign shipping_cost = settings.ph_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'QAR' %}
  {% assign shipping_treshold = settings.qa_shipping_treshold %}
  {% assign shipping_cost = settings.qa_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'SAR' %}
  {% assign shipping_treshold = settings.sa_shipping_treshold %}
  {% assign shipping_cost = settings.sa_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'KRW' %}
  {% assign shipping_treshold = settings.kr_shipping_treshold %}
  {% assign shipping_cost = settings.kr_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'SEK' %}
  {% assign shipping_treshold = settings.se_shipping_treshold %}
  {% assign shipping_cost = settings.se_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'TWD' %}
  {% assign shipping_treshold = settings.tw_shipping_treshold %}
  {% assign shipping_cost = settings.tw_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'THB' %}
  {% assign shipping_treshold = settings.th_shipping_treshold %}
  {% assign shipping_cost = settings.th_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'AED' %}
  {% assign shipping_treshold = settings.ae_shipping_treshold %}
  {% assign shipping_cost = settings.ae_shipping_cost | times: 100 | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'SGD' %}
  {% assign shipping_treshold = settings.shipping_treshold | times: threshold_sgd_rate | round %}
  {% assign shipping_cost = base_shipping_cents | times: shipping_sgd_rate | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'NZD' %}
  {% assign shipping_treshold = settings.shipping_treshold | times: threshold_nzd_rate | round %}
  {% assign shipping_cost = base_shipping_cents | times: shipping_nzd_rate | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% elsif cart.currency.iso_code == 'HKD' %}
  {% assign shipping_treshold = settings.shipping_treshold | times: threshold_hkd_rate | round %}
  {% assign shipping_cost = base_shipping_cents | times: shipping_hkd_rate | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% else %}
  {% assign shipping_treshold = settings.shipping_treshold %}
  {%- liquid
    assign ig_test_groups = cart.attributes.igTestGroups
    # Override shipping threshold based on test group
    if ig_test_groups != blank
      # Test Group: $125 threshold
      if ig_test_groups contains '5ea693784504'
        assign shipping_treshold = 125
      endif
      # Test Group: $165 threshold
      if ig_test_groups contains '2b8332f4be81'
        assign shipping_treshold = 165
      endif
    endif
  -%}
  {% assign shipping_cost = base_shipping_cents | round %}
  {% assign total_cart = cart.total_price | plus: shipping_cost | divided_by: 100 | format: "%.2f" %}
{% endif %}

{% assign totalrange = cart.total_price | divided_by: 100 | format: "%.2f" %}

<input type="hidden" class="set_cart" value="{{ total_cart }}">
<input type="hidden" class="set_range" value="{{ totalrange }}">

{%- for block in section.blocks -%}
  {% assign cartamount = cart.original_total_price | divided_by: 100 %}
  {% assign ruleamount = block.settings.spendamount | times: 1 %}
  {% if cartamount < ruleamount %}
    {% assign spendmsg = ruleamount | minus : cartamount %}
    {% assign spendrulmsg = block.settings.spendamountmsg %}
    {% assign previndex = forloop.index | minus:1 %}
    {% break %}
  {% endif %}
{%- endfor -%}

{%- for block in section.blocks -%}
  {% if forloop.first == true %}
    {% assign firstindex = block.settings.spendamount | times: 1 %}
    {%- liquid
      assign ig_test_groups = cart.attributes.igTestGroups
      # Override shipping threshold based on test group
      if ig_test_groups != blank
        # Test Group: $125 threshold
        if ig_test_groups contains '5ea693784504'
          assign firstindex = 125
        endif
        # Test Group: $165 threshold
        if ig_test_groups contains '2b8332f4be81'
          assign firstindex = 165
        endif
      endif
    -%}
    {% if cart.currency.iso_code == 'USD' %}
      {% assign firstindex = settings.us_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'CAD' %}
      {% assign firstindex = settings.ca_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'EUR' %}
      {% assign firstindex = settings.eu_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'GBP' %}
      {% assign firstindex = settings.gb_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'BHD' %}
      {% assign firstindex = settings.bh_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'DKK' %}
      {% assign firstindex = settings.dk_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'INR' %}
      {% assign firstindex = settings.in_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'JPY' %}
      {% assign firstindex = settings.jp_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'KWD' %}
      {% assign firstindex = settings.kw_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'MYR' %}
      {% assign firstindex = settings.my_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'OMR' %}
      {% assign firstindex = settings.om_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'PHP' %}
      {% assign firstindex = settings.ph_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'QAR' %}
      {% assign firstindex = settings.qa_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'SAR' %}
      {% assign firstindex = settings.sa_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'KRW' %}
      {% assign firstindex = settings.kr_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'SEK' %}
      {% assign firstindex = settings.se_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'TWD' %}
      {% assign firstindex = settings.tw_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'THB' %}
      {% assign firstindex = settings.th_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'AED' %}
      {% assign firstindex = settings.ae_shipping_treshold %}
    {% elsif cart.currency.iso_code == 'SGD' %}
      {% assign firstindex = shipping_treshold %}
    {% elsif cart.currency.iso_code == 'NZD' %}
      {% assign firstindex = shipping_treshold %}
    {% elsif cart.currency.iso_code == 'HKD'%}
      {% assign firstindex = shipping_treshold %}
    {% endif %}
    {% assign firstmsg = block.settings.spendamountmsg %}
  {% endif %}

  {% if forloop.last == true %}
    {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% if cart.currency.iso_code == 'USD' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'CAD' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'EUR' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'GBP' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'BHD' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'DKK' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'INR' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'JPY' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'KWD' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'MYR' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'OMR' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'PHP' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'QAR' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'SAR' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'KRW' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'SEK' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'TWD' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'THB' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'AED' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 %}
    {% elsif cart.currency.iso_code == 'SGD' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 | times: threshold_sgd_rate | round %}
    {% elsif cart.currency.iso_code == 'NZD' %}
      {% assign lastindex = block.settings.spendamount | times: 1.0 | times: threshold_nzd_rate | round %}
    {% elsif cart.currency.iso_code == 'HKD'%}
      {% assign lastindex = block.settings.spendamount | times: 1.0 | times: threshold_hkd_rate | round %}
    {% endif %}
    {% assign lastmsg = block.settings.spendamountmsg %}
  {% endif %}
{% endfor %}

{%- for block in section.blocks -%}
  {% if forloop.last == true %}
    {% assign lastindexnozero = block.settings.spendamount %}
    {% if cart.currency.iso_code == 'USD' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'CAD' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'EUR' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'GBP' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'BHD' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'DKK' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'INR' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'JPY' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'KWD' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'MYR' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'OMR' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'PHP' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'QAR' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'SAR' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'KRW' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'SEK' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'TWD' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'THB' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'AED' %}
      {% assign lastindexnozero = block.settings.spendamount %}
    {% elsif cart.currency.iso_code == 'SGD' %}
      {% assign lastindexnozero = block.settings.spendamount | times: threshold_sgd_rate | round %}
    {% elsif cart.currency.iso_code == 'NZD' %}
      {% assign lastindexnozero = block.settings.spendamount | times: threshold_nzd_rate | round %}
    {% elsif cart.currency.iso_code == 'HKD'%}
      {% assign lastindexnozero = block.settings.spendamount | times: threshold_hkd_rate | round %}
    {% endif %}
    {% assign lastindexof = forloop.index %}
  {% endif %}
{% endfor %}

{% assign xxxs = firstindex | times: 100.0 %}
{% assign firstpos = xxxs | divided_by: lastindex %}
{% assign perc = cartamount | divided_by: lastindex | times: 100 %}
{% assign cartamount = cart.original_total_price | divided_by: 100 %}
{% if cartamount > lastindex %}
  {% assign perc = '102.5' %}
  {% assign previndex = lastindexof %}
{% endif %}

<div class="off1 progress-container">
  <div class="offer">General Offer</div>
  <div class="progress-bar">
    <div class="milestone top-mon milone">
      {{ localization.country.currency.symbol }}{{ firstindex }}
    </div>
    <div class="milestone top-mon miltwo">
      {{ localization.country.currency.symbol }}{{ lastindexnozero }}
    </div>
    <div class="linertop milestone milone">|</div>
    <div class="linertop milestone miltwo">|</div>
    <div class="progress"></div>
    <div class="progress-circle"></div>
    <div class="linerbot milestone milone">|</div>
    <div class="linerbot milestone miltwo">|</div>
    <div class="milestone bot-mon milone">{{ firstmsg }}</div>
    <div class="milestone bot-mon miltwo">{{ lastmsg }}</div>
  </div>
  <div class="progress-text">
    <span class="notif-inc">
      Add <strong>{% case cart.currency.iso_code %}{% when 'AUD' %}${% when 'HKD' %}HK${% when 'NZD' %}NZ${% when 'SGD' %}S${% when 'CAD' %}CA${% when 'GBP' %}£{% when 'EUR' %}€{% when 'USD' %}${% when 'BHD' %}BD{% when 'DKK' %}kr{% when 'INR' %}₹{% when 'JPY' %}¥{% when 'KWD' %}KD{% when 'MYR' %}RM{% when 'OMR' %}OMR{% when 'PHP' %}₱{% when 'QAR' %}QR{% when 'SAR' %}SR{% when 'KRW' %}₩{% when 'SEK' %}kr{% when 'TWD' %}NT${% when 'THB' %}฿{% when 'AED' %}AED{% else %}${% endcase %}<span class="amount-needed"></span></strong> more to cart to get <b>{{ firstmsg }}</b>
    </span>
    {% if cart.currency.iso_code == 'USD' or cart.currency.iso_code == 'AUD' or cart.currency.iso_code == 'NZD' %}
        <span class="notif-com1">
          Congratulations! You get FREE <b>Standard Shipping</b> and <b>FREE
          {% if cart.currency.iso_code == 'HKD'%}HK$208{% elsif cart.currency.iso_code == 'GBP' %}£25{% elsif cart.currency.iso_code == 'EUR' %}€30{% elsif cart.currency.iso_code == 'CAD' %}CA$50{% else %}$40{% endif %} Gift Card</b>
        </span>
    {% else %}
        <span class="notif-com1">
          Congratulations! You get FREE <b>Standard Shipping</b> 
        </span>    
    {% endif %}
  </div>
</div>

{% comment %}
  <li><p>{{block.settings.spendamount | times: 100 | money_without_trailing_zeros}}</p><p>{{block.settings.spendamountmsg }}</p></li>
{% endcomment %}

<div class="off2 progress-container" style="display:none">
  {% assign women_scrub_tops = 0 %}
  {% assign women_scrub_pants = 0 %}
  {% assign men_scrub_tops = 0 %}
  {% assign men_scrub_pants = 0 %}

  {% for item in cart.items %}
    {% if item.product.type == "Women Scrub Tops" %}
      {% assign women_scrub_tops = women_scrub_tops | plus: item.quantity %}
    {% elsif item.product.type == "Women Scrub Pants" %}
      {% assign women_scrub_pants = women_scrub_pants | plus: item.quantity %}
    {% elsif item.product.type == "Men Scrub Tops" %}
      {% assign men_scrub_tops = men_scrub_tops | plus: item.quantity %}
    {% elsif item.product.type == "Men Scrub Pants" %}
      {% assign men_scrub_pants = men_scrub_pants | plus: item.quantity %}
    {% endif %}
  {% endfor %}

  {% assign women_sets = women_scrub_tops | minus: women_scrub_pants %}
  {% if women_sets > 0 %}
    {% assign women_sets = women_scrub_pants %}
  {% else %}
    {% assign women_sets = women_scrub_tops %}
  {% endif %}

  {% assign men_sets = men_scrub_tops | minus: men_scrub_pants %}
  {% if men_sets > 0 %}
    {% assign men_sets = men_scrub_pants %}
  {% else %}
    {% assign men_sets = men_scrub_tops %}
  {% endif %}

  {% assign total_sets = women_sets | plus: men_sets %}

  <input type="hidden" class="set_count" value="{{ total_sets }}">
  <div class="offer">Scrubs Offer</div>
  <div class="progress-bar">
    <div class="milestone top-mon miltwo">2 Sets of Scrubs</div>
    <div class="linertop milestone miltwo">|</div>
    <div class="progress"></div>
    <div class="progress-circle"></div>
    <div class="linerbot milestone milone">|</div>
    <div class="linerbot milestone miltwo">|</div>
    <div class="milestone bot-mon miltwo">FREE pair</div>
  </div>
  <div class="progress-text">
    <span class="notif-inc">
      Add <strong><span class="amount-needed"></span></strong> more set to get a<span class="another">another</span> <b class="promo">FREE SET</b>
    </span>
    <span class="notif-com1">Congratulations! You get a <b>FREE SET</b></span>
  </div>
</div>

<div class="off3 progress-container" style="display:none">
  <div class="offer">Compression Socks Offer</div>
  <div class="progress-bar">
    <div class="milestone top-mon milone">4 Socks</div>
    <div class="milestone top-mon miltwo">6 Socks</div>
    <div class="linertop milestone milone">|</div>
    <div class="linertop milestone miltwo">|</div>
    <div class="progress"></div>
    <div class="progress-circle"></div>
    <div class="linerbot milestone milone">|</div>
    <div class="linerbot milestone miltwo">|</div>
    <div class="milestone bot-mon milone">FREE Pair</div>
    <div class="milestone bot-mon miltwo">30% OFF</div>
  </div>
  <div class="progress-text">
    <span class="notif-com1">Congratulations! You get <b>30% OFF</b> on your Compression Socks order</span>
    <span class="notif-inc">
      Add <strong><span class="amount-needed"></span></strong> more Compression Socks to get <span class="another">another</span> <b class="get2">30% Off.</b>
    </span>
  </div>
</div>

<div class="off4 progress-container" style="display:none">
  <div class="offer">Printed Scrub Tops Offer</div>
  <div class="progress-bar">
    <div class="milestone top-mon milone">Buy 2</div>
    <div class="milestone top-mon miltwo">Buy 3</div>
    <div class="linertop milestone milone">|</div>
    <div class="linertop milestone miltwo">|</div>
    <div class="progress"></div>
    <div class="progress-circle"></div>
    <div class="linerbot milestone milone">|</div>
    <div class="linerbot milestone miltwo">|</div>
    <div class="milestone bot-mon milone">10% OFF</div>
    <div class="milestone bot-mon miltwo">15% OFF</div>
  </div>
  <div class="progress-text">
    <span class="notif-com1"></span>
    <span class="notif-inc">
      Add <strong><span class="amount-needed"></span></strong> more to get <span class="another"></span><b class="get2">15% OFF</b>
    </span>
  </div>
</div>

<div class="off5 progress-container" style="display:none">
  <div class="offer">Scrub Caps</div>
  <div class="progress-bar">
    <div class="milestone top-mon milone">Add 4 Scrub Caps</div>
    <div class="linertop milestone milone">|</div>
    <div class="progress"></div>
    <div class="progress-circle"></div>
    <div class="linerbot milestone milone">|</div>
    <div class="milestone bot-mon milone">15% OFF</div>
  </div>
  <div class="progress-text">
    <span class="notif-com1">Congratulations! You get one <b>15%OFF</b> on your order</span>
    <span class="notif-inc"></span>
  </div>
</div>

<script>
  function updateCartProgress() {
    // Check if required elements exist
    if (!document.querySelector(".totalin") || !document.querySelector(".totalin_hidden")) {
      console.error("Required cart elements not found");
      return;
    }

    document.querySelectorAll(".another").forEach(el => el.style.display = 'none');

    function parsePrice(priceStr) {
      let cleaned = priceStr.replace(/[^0-9.,]/g, '');
      let lastComma = cleaned.lastIndexOf(',');
      let lastPeriod = cleaned.lastIndexOf('.');
      
      if (lastComma > lastPeriod) {
        return parseFloat(cleaned.replace(/\./g, '').replace(',', '.'));
      } else {
        return parseFloat(cleaned.replace(/,/g, ''));
      }
    }

    function parseValue(priceStr) {
      let pricer = parseFloat(priceStr / 100);
      return pricer;
    }

    var totalcart = parsePrice(document.querySelector(".totalin").innerHTML);
    {% if cart.currency.iso_code == 'QAR' %}
      var totalxxd = parsePrice(document.querySelector(".totalin_hidden").innerHTML);
    {% else %}
      var totalxxd = parseValue(document.querySelector(".totalin_value_only").innerHTML);
    {% endif %}
    var totalfk = parsePrice(document.querySelector(".totalin_hidden").innerHTML);
    var progress = 0;
    progress = totalxxd;
    console.clear()
    console.log(progress + " | " + {{ firstindex }} )
    {% if cart.currency.iso_code == 'USD' or cart.currency.iso_code == 'AUD' or cart.currency.iso_code == 'NZD' %}
        var progressPercentage1 = (progress / {{ lastindex }}) * 100;
    {% else %}
        var progressPercentage1 = (progress / {{ firstindex }}) * 100;
    {% endif %}
    // Clamp percentage between 0 and 100
    if (progressPercentage1 < 0) progressPercentage1 = 0;
    if (progressPercentage1 > 100) progressPercentage1 = 100;
    {% if cart.currency.iso_code == 'USD' or cart.currency.iso_code == 'AUD' or cart.currency.iso_code == 'NZD' %}
        {% if cart.currency.iso_code == 'USD' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'CAD' %}
          if (totalcart >= 450) {
        {% elsif cart.currency.iso_code == 'EUR' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'GBP' %}
          if (totalcart >= 220) {
        {% elsif cart.currency.iso_code == 'BHD' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'DKK' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'INR' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'JPY' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'KWD' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'MYR' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'OMR' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'PHP' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'QAR' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'SAR' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'KRW' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'SEK' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'TWD' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'THB' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'AED' %}
          if (totalcart >= 350) {
        {% elsif cart.currency.iso_code == 'SGD' %}
          var tempval = 350 * {{ threshold_sgd_rate }};
          if (totalcart >= tempval) {
        {% elsif cart.currency.iso_code == 'NZD' %}
          var tempval = 350 * {{ threshold_nzd_rate }};
          if (totalcart >= tempval) {
        {% elsif cart.currency.iso_code == 'HKD'%}
          var tempval = 350 * {{ threshold_hkd_rate }};
          if (totalcart >= tempval) {
        {% else %}
          if (totalcart >= 350) {
        {% endif %}

          var notifInc = document.querySelector('.off1 .notif-inc');
          var notifCom1 = document.querySelector('.off1 .notif-com1');
          var progressBar = document.querySelector('.off1 .progress');
          var progressCircle = document.querySelector('.off1 .progress-circle');

          if (notifInc) notifInc.style.display = 'none';
          if (notifCom1) notifCom1.style.display = 'block';
          if (progressBar) progressBar.style.width = '100%';
          if (progressCircle) progressCircle.style.left = 'calc(100%)';

        } else {
          /* free shipping */
          {% if cart.currency.iso_code == 'USD' %}
            if (totalcart < {{ settings.us_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'CAD' %}
            if (totalcart < {{ settings.ca_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'EUR' %}
            if (totalcart < {{ settings.eu_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'GBP' %}
            if (totalcart < {{ settings.gb_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'BHD' %}
            if (totalcart < {{ settings.bh_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'DKK' %}
            if (totalcart < {{ settings.dk_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'INR' %}
            if (totalcart < {{ settings.in_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'JPY' %}
            if (totalcart < {{ settings.jp_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'KWD' %}
            if (totalcart < {{ settings.kw_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'MYR' %}
            if (totalcart < {{ settings.my_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'OMR' %}
            if (totalcart < {{ settings.om_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'PHP' %}
            if (totalcart < {{ settings.ph_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'QAR' %}
            if (totalcart < {{ settings.qa_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'SAR' %}
            if (totalcart < {{ settings.sa_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'KRW' %}
            if (totalcart < {{ settings.kr_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'SEK' %}
            if (totalcart < {{ settings.se_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'TWD' %}
            if (totalcart < {{ settings.tw_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'THB' %}
            if (totalcart < {{ settings.th_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'AED' %}
            if (totalcart < {{ settings.ae_shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'HKD'%}
            if (totalcart < {{ shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'SGD' %}
            if (totalcart < {{ shipping_treshold }}) {
          {% elsif cart.currency.iso_code == 'NZD' %}
            if (totalcart < {{ shipping_treshold }}) {
          {% else %}
            {%- liquid
              assign shipping_treshold = settings.shipping_treshold
              assign ig_test_groups = cart.attributes.igTestGroups
              # Override shipping threshold based on test group
              if ig_test_groups != blank
                # Test Group: $125 threshold
                if ig_test_groups contains '5ea693784504'
                  assign shipping_treshold = 125
                endif
                # Test Group: $165 threshold
                if ig_test_groups contains '2b8332f4be81'
                  assign shipping_treshold = 165
                endif
              endif
            -%}
            if (totalcart < {{ shipping_treshold }}) {
          {% endif %}

            var notifInc = document.querySelector('.off1 .notif-inc');
            var notifCom1 = document.querySelector('.off1 .notif-com1');
            var progressBar = document.querySelector('.off1 .progress');
            var progressCircle = document.querySelector('.off1 .progress-circle');
            var amountNeededEl = document.querySelector('.off1 .amount-needed');

            if (totalfk == 0) {
              if (notifInc) notifInc.style.display = 'none';
            } else {
              if (notifInc) notifInc.style.display = 'block';
            }
            if (notifCom1) notifCom1.style.display = 'none';
            if (progressBar) progressBar.style.width = progressPercentage1 + '%';
            if (progressCircle) progressCircle.style.left = 'calc(' + progressPercentage1 + '% )';

            var amountNeeded = {{ firstindex }} - totalxxd;
            if (amountNeededEl) amountNeededEl.innerHTML = amountNeeded.toFixed(2);

            console.log("eto na this {{ firstindex  }} - " + totalfk);

          } else {

            var notifInc = document.querySelector('.off1 .notif-inc');
            var notifCom1 = document.querySelector('.off1 .notif-com1');
            var progressBar = document.querySelector('.off1 .progress');
            var progressCircle = document.querySelector('.off1 .progress-circle');
            var notifIncB = document.querySelector('.off1 .notif-inc b');
            var amountNeededEl = document.querySelector('.off1 .amount-needed');

            if (notifInc) notifInc.style.display = 'block';
            if (notifCom1) notifCom1.style.display = 'none';
            if (progressBar) progressBar.style.width = progressPercentage1 + '%';
            if (progressCircle) progressCircle.style.left = 'calc(' + progressPercentage1 + '% )';
            
            var amountNeeded = {{ lastindex }} - totalcart;
            {% if cart.currency.iso_code == 'HKD'%}
              if (notifIncB) notifIncB.innerHTML = "FREE HK$208 Gift Card";
            {% elsif cart.currency.iso_code == 'GBP' %}
              if (notifIncB) notifIncB.innerHTML = "FREE £25 Gift Card";
            {% elsif cart.currency.iso_code == 'EUR' %}
              if (notifIncB) notifIncB.innerHTML = "FREE €30 Gift Card";
            {% elsif cart.currency.iso_code == 'CAD' %}
              if (notifIncB) notifIncB.innerHTML = "FREE CA$50 Gift Card";
            {% else %}
              if (notifIncB) notifIncB.innerHTML = "FREE $40 Gift Card";
            {% endif %}
            if (amountNeededEl) amountNeededEl.innerHTML = amountNeeded.toFixed(2);
          }
        }

    {% else %}
            /* no free shipping */
            {% if cart.currency.iso_code == 'USD' %}
              if (totalfk < {{ settings.us_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'CAD' %}
              if (totalfk < {{ settings.ca_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'EUR' %}
              if (totalfk < {{ settings.eu_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'GBP' %}
              if (totalfk < {{ settings.gb_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'BHD' %}
              if (totalfk < {{ settings.bh_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'DKK' %}
              if (totalfk < {{ settings.dk_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'INR' %}
              if (totalfk < {{ settings.in_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'JPY' %}
              if (totalfk < {{ settings.jp_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'KWD' %}
              if (totalfk < {{ settings.kw_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'MYR' %}
              if (totalfk < {{ settings.my_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'OMR' %}
              if (totalfk < {{ settings.om_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'PHP' %}
              if (totalfk < {{ settings.ph_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'QAR' %}
              if (totalfk < {{ settings.qa_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'SAR' %}
              if (totalfk < {{ settings.sa_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'KRW' %}
              if (totalfk < {{ settings.kr_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'SEK' %}
              if (totalfk < {{ settings.se_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'TWD' %}
              if (totalfk < {{ settings.tw_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'THB' %}
              if (totalfk < {{ settings.th_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'AED' %}
              if (totalfk < {{ settings.ae_shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'HKD' %}
              if (totalfk < {{ shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'SGD' %}
              if (totalfk < {{ shipping_treshold }}) {
            {% elsif cart.currency.iso_code == 'NZD' %}
              if (totalfk < {{ shipping_treshold }}) {
            {% else %}
              {%- liquid
                assign shipping_treshold = settings.shipping_treshold
                assign ig_test_groups = cart.attributes.igTestGroups
                # Override shipping threshold based on test group
                if ig_test_groups != blank
                  # Test Group: $125 threshold
                  if ig_test_groups contains '5ea693784504'
                    assign shipping_treshold = 125
                  endif
                  # Test Group: $165 threshold
                  if ig_test_groups contains '2b8332f4be81'
                    assign shipping_treshold = 165
                  endif
                endif
              -%}
              if (totalfk < {{ shipping_treshold }}) {
            {% endif %}



            var notifInc = document.querySelector('.off1 .notif-inc');
            var notifCom1 = document.querySelector('.off1 .notif-com1');
            var progressBar = document.querySelector('.off1 .progress');
            var progressCircle = document.querySelector('.off1 .progress-circle');
            var amountNeededEl = document.querySelector('.off1 .amount-needed');

            if (totalfk == 0) {
              if (notifInc) notifInc.style.display = 'none';
            } else {
              if (notifInc) notifInc.style.display = 'block';
            }
            if (notifCom1) notifCom1.style.display = 'none';
            if (progressBar) progressBar.style.width = progressPercentage1 + '%';
            if (progressCircle) progressCircle.style.left = 'calc(' + progressPercentage1 + '% )';

            var amountNeeded = {{ firstindex }} - totalxxd;
            if (amountNeededEl) amountNeededEl.innerHTML = amountNeeded.toFixed(2);

            console.log("eto na this {{ firstindex  }} - " + totalfk);

          } else {
            /* free shipping */ 

            var notifInc = document.querySelector('.off1 .notif-inc');
            var notifCom1 = document.querySelector('.off1 .notif-com1');
            var progressBar = document.querySelector('.off1 .progress');
            var progressCircle = document.querySelector('.off1 .progress-circle');
            var notifIncB = document.querySelector('.off1 .notif-inc b');
            var amountNeededEl = document.querySelector('.off1 .amount-needed');

            if (notifInc) notifInc.style.display = 'none';
            if (notifCom1) notifCom1.style.display = 'block';
            if (progressBar) progressBar.style.width = '100%';
            if (progressCircle) progressCircle.style.left = 'calc(100%)';
            
            var amountNeeded = {{ lastindex }} - totalcart;
            // if (amountNeededEl) amountNeededEl.innerHTML = amountNeeded.toFixed(2);
          }        
    {% endif %}


    var sockcount = 0;
    var scrubcount = 0;
    var capscount = 0;
    var scrunchiescount = 0;
    var carttype;
    var proqty;

    // Get setCount ONCE, outside the loop
    var setCountElement = document.querySelector(".set_count");
    var setCount = setCountElement ? setCountElement.value : 0;

    document.querySelectorAll('.cart__item').forEach(function(item) {
      var qtyElement = item.querySelector(".Custom_cart__quantity");
      var typeElement = item.querySelector(".protype");
      
      if (!qtyElement || !typeElement) return;
      
      proqty = qtyElement.value;
      carttype = typeElement.value;

      if (carttype == "Compression Socks") {
        sockcount = sockcount + parseInt(proqty);
      }

      if (carttype == "Printed Pattern Scrub Tops") {
        capscount = capscount + parseInt(proqty);
      }

      if (carttype == "Surgical Scrub Cap") {
        scrunchiescount = scrunchiescount + parseInt(proqty);
      }
    });

    var off2 = document.querySelector(".off2");
    if (setCount > 0 && off2) {
      off2.style.display = 'block';

      const progress = document.querySelector('.off2 .progress');
      const progressCircle = document.querySelector('.off2 .progress-circle');
      const notifInc = document.querySelector('.off2 .notif-inc');
      const notifCom1 = document.querySelector('.off2 .notif-com1');
      const notifCom2 = document.querySelector('.off2 .notif-com2');

      if (notifInc) notifInc.style.display = 'none';
      if (notifCom1) notifCom1.style.display = 'none';
      if (notifCom2) notifCom2.style.display = 'none';

      if (setCount == 1) {
        if (progress) progress.style.width = '50%';
        if (progressCircle) progressCircle.style.left = 'calc(50% )';
        if (notifCom1) {
          notifCom1.innerHTML = "Add 1 more set to get 1 compression socks for FREE";
          notifCom1.style.display = 'block';
        }
      } else {
        if (progress) progress.style.width = '100%';
        if (progressCircle) progressCircle.style.left = 'calc(100% )';
        if (sockcount == 0) {
          if (notifCom1) {
            notifCom1.innerHTML = "<span style='color:red'><br/>Don't forget to add the FREE compression socks to your cart!</span>";
            notifCom1.style.display = 'block';
          }
        } else {
          if (notifCom1) notifCom1.style.display = 'none';
        }

        if (notifInc) {
          notifInc.innerHTML = "Congratulations! You get a FREE pair of compression socks";
          notifInc.style.display = 'block';
        }
      }
    } else if (off2) {
      off2.style.display = 'none';
    }

    var off3 = document.querySelector(".off3");
    if (sockcount > 0 && off3) {
      off3.style.display = 'block';
      var sockcountpercent = (sockcount / 6) * 100;
      var sockcountfull = 6 - sockcount;
      
      var notifInc = document.querySelector('.off3 .notif-inc');
      var notifCom1 = document.querySelector('.off3 .notif-com1');
      var notifCom2 = document.querySelector('.off3 .notif-com2');
      var progressBar = document.querySelector('.off3 .progress');
      var progressCircle = document.querySelector('.off3 .progress-circle');
      var amountNeededEl = document.querySelector('.off3 .amount-needed');
      var get2El = document.querySelector('.off3 .get2');
      var anotherEl = document.querySelector(".off3 .another");

      if (sockcount >= 6) {
        if (notifInc) notifInc.style.display = 'none';
        if (notifCom1) {
          notifCom1.style.display = 'block';
          notifCom1.innerHTML = "Congratulations! You get <b>30% OFF</b> on your Compression Socks order";
        }
        if (progressBar) progressBar.style.width = '100%';
        if (progressCircle) progressCircle.style.left = 'calc(100% )';
      } else {
        if (progressBar) progressBar.style.width = sockcountpercent + '%';
        if (progressCircle) progressCircle.style.left = 'calc(' + sockcountpercent + '% )';
        
        if (sockcount < 4) {
          if (anotherEl) anotherEl.style.display = 'none';
          if (notifInc) notifInc.style.display = 'block';
          if (notifCom1) notifCom1.style.display = 'none';
          if (notifCom2) notifCom2.style.display = 'none';
          var amountNeeded = 4 - sockcount;
          if (amountNeededEl) amountNeededEl.innerHTML = amountNeeded;
          if (get2El) get2El.innerHTML = "FREE pair of Compression Socks";
        } else {
          if (sockcount < 6) {
            if (anotherEl) anotherEl.style.display = 'none';
            if (notifInc) notifInc.style.display = 'block';
            if (notifCom1) {
              notifCom1.style.display = 'block';
              notifCom1.innerHTML = "Congratulations! You get a <b>FREE pair</b> of Compression Socks.<br/>";
            }
            if (get2El) get2El.innerHTML = "30% OFF";
            var amountNeeded = 6 - sockcount;
            if (amountNeededEl) amountNeededEl.innerHTML = amountNeeded;
          } else {
            if (notifInc) notifInc.style.display = 'none';
            if (notifCom2) notifCom2.style.display = 'none';
            var amountNeeded = 6 - sockcount;
            if (amountNeededEl) amountNeededEl.innerHTML = amountNeeded;
          }
        }
      }
    } else if (off3) {
      off3.style.display = 'none';
    }

    var off4 = document.querySelector(".off4");
    if (capscount > 0 && off4) {
      off4.style.display = 'block';
      var capscountpercent = (capscount / 3) * 100;
      var capscountfull = 3 - capscount;
      
      var notifInc = document.querySelector('.off4 .notif-inc');
      var notifCom1 = document.querySelector('.off4 .notif-com1');
      var notifCom2 = document.querySelector('.off4 .notif-com2');
      var progressBar = document.querySelector('.off4 .progress');
      var progressCircle = document.querySelector('.off4 .progress-circle');
      var amountNeededEl = document.querySelector('.off4 .amount-needed');
      var get2El = document.querySelector('.off4 .get2');
      var anotherEl = document.querySelector(".off4 .another");

      if (capscount >= 3) {
        if (notifInc) notifInc.style.display = 'none';
        if (notifCom1) {
          notifCom1.style.display = 'block';
          notifCom1.innerHTML = "You get <b>15%</b> OFF for Printed Scrub Tops";
        }
        if (progressBar) progressBar.style.width = '100%';
        if (progressCircle) progressCircle.style.left = 'calc(100% )';
      } else {
        if (progressBar) progressBar.style.width = capscountpercent + '%';
        if (progressCircle) progressCircle.style.left = 'calc(' + capscountpercent + '% )';
        
        if (capscount < 2) {
          if (anotherEl) anotherEl.style.display = 'none';
          if (notifInc) notifInc.style.display = 'block';
          if (notifCom1) notifCom1.style.display = 'none';
          if (notifCom2) notifCom2.style.display = 'none';
          var amountNeeded = 2 - capscount;
          if (amountNeededEl) amountNeededEl.innerHTML = amountNeeded;
          if (get2El) get2El.innerHTML = "10% OFF for Printed Scrub Tops.";
        } else {
          if (capscount < 3) {
            if (anotherEl) anotherEl.style.display = 'none';
            if (notifInc) notifInc.style.display = 'block';
            if (notifCom1) {
              notifCom1.style.display = 'block';
              notifCom1.innerHTML = "Congratulations! You get <b>15% OFF</b> Printed Scrub Tops.<br/>";
            }
            if (get2El) get2El.innerHTML = "";
            var amountNeeded = 3 - capscount;
            if (amountNeededEl) amountNeededEl.innerHTML = amountNeeded;
          } else {
            if (notifInc) notifInc.style.display = 'none';
            if (notifCom2) notifCom2.style.display = 'none';
            var amountNeeded = 3 - capscount;
            if (amountNeededEl) amountNeededEl.innerHTML = amountNeeded;
          }
        }
      }
    } else if (off4) {
      off4.style.display = 'none';
    }

    var off5 = document.querySelector(".off5");
    if (scrunchiescount > 0 && off5) {
      off5.style.display = 'block';
      var scrunchiespercent = (scrunchiescount / 4) * 100;
      var scrunchiescountfull = 4 - scrunchiescount;
      
      var notifInc = document.querySelector('.off5 .notif-inc');
      var notifCom1 = document.querySelector('.off5 .notif-com1');
      var notifCom2 = document.querySelector('.off5 .notif-com2');
      var progressBar = document.querySelector('.off5 .progress');
      var progressCircle = document.querySelector('.off5 .progress-circle');
      var amountNeededEl = document.querySelector('.off5 .amount-needed');

      if (scrunchiescount >= 4) {
        if (notifInc) notifInc.style.display = 'none';
        if (notifCom1) notifCom1.style.display = 'block';
        if (progressBar) progressBar.style.width = '100%';
        if (progressCircle) progressCircle.style.left = 'calc(100% )';
      } else {
        if (progressBar) progressBar.style.width = scrunchiespercent + '%';
        if (progressCircle) progressCircle.style.left = 'calc(' + scrunchiespercent + '% )';

        if (notifInc) notifInc.style.display = 'block';
        if (notifCom1) notifCom1.style.display = 'none';
        if (notifCom2) notifCom2.style.display = 'none';
        var amountNeeded = 4 - scrunchiescount;
        if (amountNeededEl) amountNeededEl.innerHTML = amountNeeded;
      }
    } else if (off5) {
      off5.style.display = 'none';
    }
  }

  // Debounce function to prevent infinite loops
  var debounceTimer;
  function debouncedUpdateCartProgress() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(function() {
      updateCartProgress();
    }, 300);
  }

  // Run on page load
  document.addEventListener('DOMContentLoaded', updateCartProgress);

  // Listen for cart updates with debouncing to prevent infinite loops
  document.addEventListener('cart:updated', debouncedUpdateCartProgress);
  document.addEventListener('ajaxCart.afterCartLoad', debouncedUpdateCartProgress);

  // ============================================================================
  // EVENT DELEGATION for dynamically added TRIGGER elements
  // ============================================================================

  // Handle clicks on dynamically added cart buttons
  document.addEventListener('click', function(e) {
    // Check if clicked element or its parent is a quantity increase button
    const increaseBtn = e.target.closest('.cart__quantity-increase');
    if (increaseBtn) {
      console.log('Quantity increase clicked');
      debouncedUpdateCartProgress();
      return;
    }

    // Check if clicked element or its parent is a quantity decrease button
    const decreaseBtn = e.target.closest('.cart__quantity-decrease');
    if (decreaseBtn) {
      console.log('Quantity decrease clicked');
      debouncedUpdateCartProgress();
      return;
    }

    // Check if clicked element or its parent is a remove item button
    const removeBtn = e.target.closest('.cart__remove');
    if (removeBtn) {
      console.log('Remove item clicked');
      debouncedUpdateCartProgress();
      return;
    }
  });

  // Handle changes on quantity inputs (dynamically added)
  document.addEventListener('change', function(e) {
    if (e.target.matches('.Custom_cart__quantity')) {
      console.log('Quantity changed to:', e.target.value);
      debouncedUpdateCartProgress();
    }
  });

  // Handle input events for real-time updates while typing
  document.addEventListener('input', function(e) {
    if (e.target.matches('.Custom_cart__quantity')) {
      debouncedUpdateCartProgress();
    }
  });

  // ============================================================================
  // MUTATION OBSERVER for dynamically added TARGET elements
  // ============================================================================

  // Watch for cart elements being added to the DOM
  const cartObserver = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      // Check if nodes were added
      if (mutation.addedNodes.length) {
        mutation.addedNodes.forEach(function(node) {
          // Skip if not an element node
          if (node.nodeType !== 1) return;
          
          // Check if the added node itself or any child contains cart elements
          if (
            node.matches && (
              node.matches('.totalin') ||
              node.matches('.totalin_hidden') ||
              node.matches('.cart__item') ||
              node.matches('.off1, .off2, .off3, .off4, .off5') ||
              node.querySelector('.totalin') ||
              node.querySelector('.totalin_hidden') ||
              node.querySelector('.cart__item')
            )
          ) {
            console.log('Cart elements added to DOM, updating progress...');
            debouncedUpdateCartProgress();
          }
        });
      }
    });
  });

  // Start observing the document for changes
  cartObserver.observe(document.body, {
    childList: true,     // Watch for child nodes being added/removed
    subtree: true        // Watch ALL descendants, not just direct children
  });
</script>

<style>
  .top-mon {
    font-size: 10px;
    top: -25px;
  }

  .bot-mon {
    font-size: 10px;
    font-weight: 700;
    top: 20px;
  }

  .progress-container {
    width: 100%;
    padding: 20px 20px 22px;
    text-align: center;
    border-bottom: 1px solid #EBEBEB;
  }

  .off2 .progress-container {
    width: 100%;
    padding: 20px 20px 17px;
  }

  @media only and (max-width: 480px) {
    .bot-mon {
      font-size: 11px;
    }
    .progress-container {
      padding: 20px 20px 24px;
    }
  }

  .offer {
    margin-bottom: 10px;
    text-align: left;
    font-family: "futurapt";
    font-size: 12px;
    color: #A8A8A8;
    position: relative;
    top: -12px;
  }
{% if cart.currency.iso_code == 'USD' or cart.currency.iso_code == 'AUD' or cart.currency.iso_code == 'NZD' %}
  .off1 .milone {
    left: {{ firstpos }}%;
    text-align: center;
  }
  .off1 .miltwo {
    left: 95%;
    text-align: center;
  }
  .off1 .linertop.miltwo,
  .off1 .linerbot.miltwo {
    left: 98%;
    text-align: center;
  }
{% else %}
  .off1 .milone {
    left: 95%;
    text-align: center;
  }
  .off1 .miltwo {
    left: 95%;
    text-align: center;
    display:none;
  }
  .off1 .linertop.miltwo,
  .off1 .linerbot.miltwo {
    left: 98%;
    text-align: center;
    display:none;
  }
  .off1 .linertop.milone,
  .off1 .linerbot.milone {
    left: 98%;
    text-align: center;    
  }
{% endif %}

  .off2 .milone {
    left: 50%;
    text-align: center;
  }

  .off2 .miltwo {
    left: 95%;
    text-align: center;
  }

  .off2 .linertop.miltwo,
  .off2 .linerbot.miltwo {
    left: 98%;
  }

  .off4 .milone,
  .off3 .milone {
    left: 66%;
    text-align: center;
  }

  .off4 .miltwo,
  .off3 .miltwo {
    left: 95%;
    text-align: center;
  }

  .off4 .linertop.miltwo,
  .off4 .linerbot.miltwo,
  .off3 .linertop.miltwo,
  .off3 .linerbot.miltwo {
    left: 98%;
    text-align: center;
  }

  .off5 .milone {
    left: 95%;
    text-align: center;
  }

  .off5 .linertop.milone,
  .off5 .linerbot.milone {
    left: 98%;
    text-align: center;
  }

  .linertop {
    font-size: 6px;
    top: -7px;
    color: #E3E3E3;
  }

  .linerbot {
    font-size: 6px;
    top: 7px;
    color: #E3E3E3;
  }

  .progress-bar {
    position: relative;
    width: 100%;
    height: 10px;
    background: #fff;
    border: 2px solid #E3E3E3;
    border-radius: 5px;
    margin-bottom: 10px;
  }

  .progress {
    position: absolute;
    height: 100%;
    background-color: #000;
    border-radius: 5px;
    width: 0;
    position: absolute;
    height: 100%;
    background-image: url(https://cdn.shopify.com/s/files/1/0573/7250/8344/files/Animation_1715636956235_1.gif?v=1717087149);
    background-repeat: no-repeat;
    background-position: left;
    background-blend-mode: screen;
    background-size: cover;
  }

  .progress-circle {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    background-color: #ff0;
    border-radius: 50%;
    border: 2px solid #000;
  }

  .milestone {
    position: absolute;
    font-family: "futurapt";
    transform: translateX(-50%);
    white-space: nowrap;
  }

  .free-shipping {
    right: 20px;
    transform: translateX(50%);
  }

  .secret-gift {
    right: 20px;
    transform: translateX(50%);
  }

  .progress-text {
    margin-top: 10px;
    text-align: left;
    width: 100%;
    font-size: 10px;
    position: relative;
    top: 16px;
  }

  .off2 .progress-text {
    top: 0px;
  }

  @media only screen and (max-width: 480px) {
    .progress-text {
      position: relative;
      top: 18px;
      font-size: 11px;
    }
    .off1 .bot-mon.miltwo {
      left: 90%;
    }
  }

  /* from old design */
  .outer-spent {
    padding: 0px 30px;
    margin-top: -15px;
  }

  .outer-spent .unlock-msg {
    display: none;
  }

  .unlockmsg {
    position: absolute;
    margin: 0 auto;
    bottom: 0;
    left: 22px;
  }

  .unlockmsg .outer-spent .unlock-msg {
    display: block !important;
  }

  .unlockmsg .next-spend-msg,
  .unlockmsg .spend-progress-main {
    display: none;
  }

  .unlock-msg div:last-child {
    padding: 10px;
    font-size: 14px;
    display: flex;
    align-items: center;
  }

  .drawer__inner .outer-spent {
    padding: 0px;
    margin-top: 10px;
  }

  #tick-mark {
    position: relative;
    display: inline-block;
    width: 15px;
    height: 15px;
    margin: 0px 10px 0 0;
    top: -2px;
  }

  .slick-slide .vactive {
    border-radius: 8px;
  }

  #tick-mark::before {
    position: absolute;
    left: 0;
    top: 50%;
    height: 50%;
    width: 2px;
    background-color: #000;
    content: "";
    transform: translateX(9px) rotate(-45deg);
    transform-origin: left bottom;
  }

  #tick-mark::after {
    position: absolute;
    left: 0;
    bottom: 0;
    height: 2px;
    width: 100%;
    background-color: #000;
    content: "";
    transform: translateX(10px) rotate(-45deg);
    transform-origin: left bottom;
  }

  .unlock-msg {
    margin-top: -14px;
  }

  .cart_drawer_custom .drawer__header {
    height: auto !important;
    padding-top: 0px;
    margin-bottom: 20px;
    padding-left: 20px !important;
    padding-right: 20px !important;
    border-bottom: 1px solid #ebebeb;
  }

  .cart__product-name {
    font-family: Oxygen;
    font-size: 16px !important;
    font-weight: 900;
  }

  .cart__item-price {
    font-size: 14px;
    font-weight: 900;
  }

  .spend-progress-main ul li {
    font-weight: 800;
  }

  .header-main-cart {
    position: relative;
    border-radius: 8px;
  }

  .drawer__inner .qty-remove {
    display: block !important;
  }

  .cart-meta {
    width: 72% !important;
  }

  .quant {
    width: 27% !important;
  }

  .drawer__inner .custom_plus_minus {
    border: 2px solid #010101 !important;
    border-radius: 4px;
    margin-bottom: 20px;
  }

  .drawer__inner .custom_plus_minus .qty-icons-main {
    width: 30% !important;
  }

  .drawer__inner .custom_plus_minus input.Custom_cart__quantity {
    width: 40% !important;
  }

  .drawer__inner .custom_plus_minus input.Custom_cart__quantity,
  .drawer__inner .custom_plus_minus .qty-icons-main {
    height: 26px !important;
  }

  .cart_drawer_custom .drawer__footer {
    border-top: none !important;
  }

  .cart__details {
    margin-bottom: 20px;
    align-items: flex-start;
  }

  .cart-all-products {
    background: #f7f7f7 !important;
    border-radius: 8px;
  }

  .qty-remove .cart__item-price p {
    font-size: 14px !important;
    color: gray !important;
    display: flex;
    font-weight: 400;
    display: flex;
    flex-wrap: wrap;
    font-weight: 400;
    align-items: flex-start;
    position: relative;
    top: -12px;
  }

  .desktop-view,
  .qty-remove .cart__item-price p svg {
    margin-right: 5px;
  }

  .cart__row-product .cart__product-image-wrap {
    border-radius: 8px;
    overflow: hidden;
  }

  select {
    background-position: right 6px center !important;
  }

  .red-block {
    position: relative;
  }

  .red-block::before {
    content: '';
    position: absolute;
    top: 50%;
    right: 100%;
    margin-top: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: transparent #B53728 transparent transparent;
  }

  .cart-all-products .slick-track {
    padding-top: 0px;
    padding-bottom: 0px;
  }

  .cart__details.flexer-start {
    display: flex;
    justify-content: space-between;
  }

  .cart__details.flexer-start .red-block {
    margin-bottom: 7px;
  }

  span.br-clean {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start;
    width: 66%;
  }

  @media (max-width: 480px) {
    span.br-clean {
      width: 100%;
    }
    .cart__details.flexer-start {
      display: flex;
      justify-content: space-between;
    }
    .cart__details.flexer-start .red-block {
      display: block;
    }
    .ajaxcart__product {
      margin-bottom: 20px;
    }
    .qty-remove .cart__item-price p {
      width: 80px;
      top: -9px;
    }
    .cart__item .cart__item-subtitle {
      font-size: 14px !important;
    }
    .drawer__inner .qty-remove {
      padding-left: 0 !important;
    }
    .cart__details {
      margin-bottom: 9px !important;
    }
    .drawer__close-button {
      top: -7px;
      position: absolute !important;
      right: 9px !important;
    }
    .cart_drawer_custom .cart__item .cart__row-product {
      margin-bottom: 0 !important;
    }
    .cart_drawer_custom {
      padding: 21px 15px !important;
    }
    .drawer__footer {
      margin-top: 0 !important;
    }
    .outer-spent {
      padding: 0px 15px;
    }
    .cart__row-product {
      align-items: flex-start !important;
    }
    .cart-meta {
      width: 68% !important;
    }
    .cart__row-product .cart__product-image-wrap {
      min-width: 59px !important;
      width: 57px !important;
    }
  }
 {% if cart.currency.iso_code == 'USD' or cart.currency.iso_code == 'AUD' or cart.currency.iso_code == 'NZD' %}
    
 {% else %}
    .off1 .miltwo{display:none;}
 {% endif %}
</style>

{% schema %}
{
  "max_blocks": 4,
  "settings": [
    {
      "id": "bgcolor_bar",
      "type": "color",
      "label": "Bar and Text Color"
    }
  ],
  "blocks": [
    {
      "type": "cart-spend-section",
      "name": "Cart Spend Section",
      "settings": [
        {
          "id": "spendamount",
          "type": "text",
          "label": "Spend amount"
        },
        {
          "id": "spendamountmsg",
          "type": "text",
          "label": "Spend Shipping Message"
        }
      ]
    }
  ]
}
{% endschema %}

{% stylesheet %}
{% endstylesheet %}